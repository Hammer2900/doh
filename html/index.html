<!DOCTYPE html>
<!--
 * Copyright (c) 2012 Jake Willoughby
 * 
 * This file is part of DOH.
 * 
 * DOH is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * any later version.
 * 
 * DOH is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with DOH.  See gpl3.txt. If not, see <http://www.gnu.org/licenses/>.
-->
<html>
  <head>
    <script type="text/javascript" src="../javascript/third_party/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="../javascript/third_party/2.5.3-crypto-sha1-hmac-pbkdf2.js"></script>
    <script type="text/javascript" src="../javascript/doh.js"></script>
    <script type="text/javascript" src="../javascript/third_party/2.5.3-crypto-sha256.js"></script>
    <script>
      var DOHmaster = "";
      var DOHsalt = "";
      var DOHhashFunction = "sha256";
      var domainSpecs = null;
      var hasher = DOH.gen_password;

      // Load in specs
      $.getJSON('domain_specs.json', function (data) {
        domainSpecs = data;
      });

      function setPassword() {
        // Match top-level domain
        var host = $("#DOHdomain").val().match(/([-A-Za-z0-9]+\.)*([-A-Za-z0-9]*\.[-A-Za-z0-9]+)/);
        var val = "Invalid domain string";

        var opts = {'domain': host[2], 
          'salt': DOHsalt,
          'hashedMaster': DOHmaster,
          'seq': "0", 
          'hashFunction': DOHhashFunction};
        if (host && 2 in host) {
          val = hasher(opts);
        }

        $("#DOHpassword").val(val);
      };

      function setDOHmaster() {
        DOHmaster = Crypto.util.bytesToBase64(Crypto.SHA256($('#DOHsalt').val() + $('#DOHmaster').val(), {asBytes: true}));
      }

      function hasherChanged() {
        var h = $('input:radio[name=hasher]:checked').val();
        if (h == "DOHsha1") {
          hasher = DOH.gen_password;
          DOHhashFunction = "sha1";
        }
        else if (h == "DOHsha256") {
          hasher = DOH.gen_password;
          DOHhashFunction = "sha256";
        }
      }
    </script>
  </head>
  <body>
    <table>
      <tr>
        <td> Master Password: </td>
        <td><input type="password" id="DOHmaster" onkeyup="setDOHmaster()" /></td>
      </tr>
      <tr>
        <td>Salt:</td>
        <td><input type="text" id="DOHsalt" onkeyup="DOHsalt = $('#DOHsalt').val();setDOHmaster();" /> </td>
      </tr>
      <tr>
        <td>Domain:</td>
        <td><input type="text" id="DOHdomain"/></td>
      </tr>
    </table>
    <br />
    <input type="button" value="Generate password" onclick="setPassword()"/> <br />
    Generated Password: <input type="text" id="DOHpassword" style="width: 600px"/> <br />
    <br />
    <br />
    Hashing method: <br />
    <input type="radio" name="hasher" onchange="hasherChanged();" value="DOHsha1"> DOH - SHA1 <br />
    <input type="radio" name="hasher" onchange="hasherChanged();" value="DOHsha256" checked> DOH - SHA256 <br />

  </body>
</html>
